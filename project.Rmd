---
title: "Data Visualization Project"
author:
  - name: Antonia Carasel (gr. 505)
  - name: Mircea Vacariuc (gr. 506)
output: html_document
date: '2022-05-07'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(warn = - 1)
```

# Introduction
The objective of this project is to perform an **anlysis of Gun Violence in US** in the past decade. The statistics have as their main purpose giving a good overview of the situation for each state and discovering trends and correlations between several factors and gun violence.

We have chosen to employ both *Python* and *R* as programming languages, the former being used for data processing and modelling purposes, and the latter for the actual visualization of the data gathered.

Three data sets have been used, the primary one which includes the topic specific information, and two supporting sets that contain the population for each state according to the 2019 census and the state codes.

The data source for the project is Kaggle.

* Primary dataset: <https://www.kaggle.com/datasets/jameslko/gun-violence-data>
* US State codes: <https://worldpopulationreview.com/states/state-abbreviations>

# Settings
R specific libraries import
```{r}
library(hrbrthemes)
library(reticulate)
library(ggplot2)
library(hrbrthemes)
library(plotly)
library(tidyverse)
library(gganimate)
library(gifski)
library(viridis)
library(geojsonio)
library(geojsonR)
library(broom)
library(geojsonsf)
library(wordcloud2)
library(RColorBrewer)
library(dplyr)
library(ggthemes)
```

Python specific libraries import
```{python}
import pandas as pd
import numpy as np
import datetime as dt
```
## Data extraction from the CSV files
```{python}
fileName = 'gun-violence.csv'
fullsetDF = pd.read_csv(fileName)
fileName = 'us_population_by_state.csv'
populationDF = pd.read_csv(fileName)
fileName = 'state_codes.csv'
stateCodesDF = pd.read_csv(fileName)
```
# Data Cleaning
## Remove unnecesary data
Fields "incident_id" and "incident_url_fields_missing", are not need for our analysis so they were removed.
```{python}
fullsetDF = fullsetDF.drop("incident_id", axis = 1)
fullsetDF = fullsetDF.drop("incident_url_fields_missing", axis = 1)
```
## Processing
We have split the date into months and years since this information will be used later on when studying the changes over the years and if there are any "seasonal changes".
```{python}
def splitDates(datesList):
    months = []
    years = []
    for i in range(0, len(datesList)):
        value = datesList[i]
        splitDate = dt.datetime.strptime(value, "%Y-%m-%d")
        monthName = splitDate.strftime('%b')
        months.append(monthName)
        years.append(splitDate.year)
    fullsetDF.insert(1, "MONTH", months)
    fullsetDF.insert(2, "YEAR", years)

allDates = fullsetDF['date']
splitDates(allDates)
```

We would like to see if the type of venue has any impact on the number of incidents that occur. However, there are no clearly defined types and as such, we had to define them ourselves and see which fall into the specific category.The location can be mentioned in several fields, so we will use all of them for our search: `location_description`, `incident_characteristics`, `notes` and `sources`. A new field was added called `LocationType`.
```{python}
locationType = ["Bar/Club", "College", "School", "Apartment", "Park", "Restaurant", "Courthouse", "Tavern", "Theater"]
locations = fullsetDF["location_description"]
characteristics = fullsetDF["incident_characteristics"]
notes = fullsetDF["notes"]
sources = fullsetDF["sources"]
fieldNo = fullsetDF.columns.get_loc("location_description")

incidentLocationIdentified = []
for i in range (0, len(fullsetDF.index)):
    valueArray = []
    valueArray.append(locations[i])
    valueArray.append(characteristics[i])
    valueArray.append(notes[i])
    valueArray.append(sources[i])
    found = ""
    for j in range(0,4):
        value = valueArray[j]
        if type(value) == str:
            for k in range (0, len(locationType)):
                if locationType[k].lower() in value.lower():
                    found = locationType[k]
                    break
    if(found == ""):
        incidentLocationIdentified.append("N/A")
    else:
        incidentLocationIdentified.append(found)

fullsetDF.insert(fieldNo, "LocationType", incidentLocationIdentified)
fullsetDF = fullsetDF.drop("location_description", axis = 1)
fullsetDF = fullsetDF.drop("notes", axis = 1)
```

The field `incident_characteristics` that can be used to find types of incidents. As described previously, we have defined certain categories and searched the text to find in which categories incident fall in.

Unlike the previous example where only one venue was possible, here there can be more than one or more characteristics describing each incident, which required us to define different fields with a YES/NO response (binary categorical variables).
```{python}
incidentType = ["Home Invasion", "Mass Shooting", "Officer Involved", "Armed Robbery", "Drive-by", "Domestic Violence","Gang"]
fieldNo = fullsetDF.columns.get_loc("incident_characteristics")
matrix = []

for i in range(0, len(incidentType)):
    incidentTypeDiscovered = []
    for j in range(0, len(characteristics)):
        value = characteristics[j]
        if type(value) != float:
          if incidentType[i].lower() in value.lower():
            incidentTypeDiscovered.append("YES")
          else:
            incidentTypeDiscovered.append("NO")
        else:
          incidentTypeDiscovered.append("UNKNOWN")
    fieldName = incidentType[i]
    fullsetDF.insert(fieldNo, fieldName, incidentTypeDiscovered)
```

Field `participant_gender` offers information for all the people involved. We would like to get the actual number and add these fields to the dataframe.
```{python}
genderParticipants = fullsetDF["participant_gender"]
female = []
male = []
for i in range (0, len(genderParticipants)):
    value = genderParticipants[i]
    if type(value) != float:
        no = value.count("Female")
        female.append(no)
        no = value.count("Male")
        male.append(no)
    else:
        female.append(0)
        male.append(0)

fieldNo = fullsetDF.columns.get_loc("participant_gender")
fullsetDF.insert(fieldNo, "FEMALES", female)
fullsetDF.insert(fieldNo, "MALES", male)
```

We would also like to make the distinction between the number of adults, teenagers and children involved in the incidents and we will use the same process as above on the field `participant_age_group`.
```{python}
ageParticipants = fullsetDF["participant_age_group"]
children = []
teenagers = []
adults = []
for i in range (0, len(ageParticipants)):
    value = ageParticipants[i]
    if type(value) != float:
        no = value.count("Adult 18+")
        adults.append(no)
        no = value.count("Teen 12-17")
        teenagers.append(no)
        no = value.count("Child 0-11")
        children.append(no)
    else:
        adults.append(0)
        teenagers.append(0)
        children.append(0)
fieldNo = fullsetDF.columns.get_loc("participant_age_group")
fullsetDF.insert(fieldNo, "ADULTS", adults)
fullsetDF.insert(fieldNo, "TEENAGERS", teenagers)
fullsetDF.insert(fieldNo, "CHILDREN", children)
```

The clean dataframe was saved in a new csv file.
```{python}
fullsetDF.to_csv("gun-violence_processed-data.csv")
```

# Graphs
## Initial Data Exploration
We will start by using some simple plots to get a first view of the data analyzed.
### **Chart Type:** Barplot with one numeric variable
Calculating total numbers of

  * incidents that occured 
  * cases that resulted in killings
  * cases that resulted in injuries

in each state, regardless of month or year.
```{python}
totalPerState = []
totalKillingsPerState = []
totalInjuriesPerState = []

for i in range (0, len(stateCodesDF)):
    state = stateCodesDF["State"][i]

    dfHelper = fullsetDF[fullsetDF["state"]==state]['state'].copy(deep=True)
    totalPerState.append(dfHelper.count().item())

    dfHelper = fullsetDF[(fullsetDF["state"] == state) & (fullsetDF['n_killed'] > 0)]['state'].copy(deep=True)
    totalKillingsPerState.append(dfHelper.count().item())

    dfHelper = fullsetDF[(fullsetDF["state"] == state) & (fullsetDF['n_injured'] > 0)]['state'].copy(deep=True)
    totalInjuriesPerState.append(dfHelper.count().item())

stateCodes = stateCodesDF["Code"]
```

We have defined a function for this type of plot and called it for each of the scenarios. A barplot uses a single numeric variable and a categoric variable.
```{r}
initial_eda_barplots <- function(all_labels, all_values, x_name, y_name, plot_title, colour){
  
  data=data.frame(name = all_labels, value = all_values)

  totalIncidentsBarPlot <- ggplot(data, aes(x=name, y = value)) + geom_bar(stat = "identity", width=0.7, fill = colour) + 
    xlab(x_name) + 
    ylab(y_name) +
    ggtitle(plot_title) +
    theme(
      plot.title = element_text(hjust = 0.5),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white"), 
      axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
  ggplotly(totalIncidentsBarPlot)
}
```

We first want to see the distribution of the total number of incidents per each state. We will use the `totalPerState` dataframe and the codes from the `stateCodes` array.

**Numeric Variable: Total number of incidents that occured**

**Categoric Variable: State codes**
```{r}
r_totalPerState <- py$totalPerState
r_labels <- py$stateCodes

initial_eda_barplots(r_labels, r_totalPerState, "State Code", "Number of incidents", "Distribution of incidents per State", "#091CC1")
```

The general level of incidents can roughly be found somewhere in the interval [0,5000], but we do see some outliers - states have a significantly higher number of gun-involved cases.

**Numeric Variable: Total number of cases that resulted in deaths**

**Categoric Variable: State codes**
```{r}
r_totalKillingsPerState <- py$totalKillingsPerState

initial_eda_barplots(r_labels, r_totalKillingsPerState, "State Code", "Number of killings", "Distribution of cases that resulted in killings per State", "#652194")
```

The number of deaths for most states lies between 0 and 3000, with the overwhelming majority being between 0 and 2000. Outlier values go up to 5000.

**Numeric Variable: Total number of cases that resulted in injuries**

**Categoric Variable: State codes**
```{r}
r_totalInjuriesPerState <- py$totalInjuriesPerState

initial_eda_barplots(r_labels, r_totalInjuriesPerState, "State Code", "Number of injuries", "Distribution of cases that resulted in injuries per State", "#134611")
```

Number of injuries per state is between 0 and 6000 for all states but one - that exception being over 9000.

Outlier values can be noticed in the last two charts as well. Given this observation, it would make sense to realize another chart - a Boxplot - that would specifically highlight this information. Even though boxplots can sometimes be misleading because of the loss of information, our purpose for this scenario is to identify those states that do not fall into the IQR (Interquantile Range), purpose which makes this type of chart appropriate.

### **Chart Type:** Boxplot with three series
A boxplot uses one or more numeric variables and since we would like to make a comparison between the three series, we will plot them all together.

**Three Numeric Variables:**
  **Total number of incidents for each state**
  **Total number of firearm deaths for each state**
  **Total number of firearm injuries for each state**
```{r}
r_totalPerState <- py$totalPerState
r_totalKillingsPerState <- py$totalKillingsPerState
r_totalInjuriesPerState <- py$totalInjuriesPerState

p <- boxplot(r_totalPerState, r_totalKillingsPerState, r_totalInjuriesPerState,
main = "Outlier variables - States that have higher criminality",
names = c("Number of incidents", "Number of killings", "Number of injuries"),
col = c("#091CC1","#652194", "#134611")
)

outliers <- p$out
```

From the boxplots, the distribution for all 3 of them (number of incidents, killings and injuries) is skewed towards lower values, with the median finding itself closer to the bottom of the chart. The outlier values can also be clearly seen, being outside the range of the whiskers of the box plots

*Extracting the outlier values from the boxplot representation:*
```{python}
outliers = r.outliers
actualStates = []

for i in range(0,4):
  for j in range (0, len(stateCodes)):
    if(totalPerState[j] == outliers[i]):
      actualStates.append(stateCodes[j])
      break

for i in range(4,6):
  for j in range (0, len(stateCodes)):
    if(totalKillingsPerState[j] == outliers[i]):
      actualStates.append(stateCodes[j])
      break

for i in range(6,7):
  for j in range (0, len(stateCodes)):
    if(totalInjuriesPerState[j] == outliers[i]):
      actualStates.append(stateCodes[j])
      break

actualStates = list(dict.fromkeys(actualStates))
outlierList = []
for i in range(0, len(actualStates)):
  outlierList.append(stateCodesDF[stateCodesDF["Code"] == actualStates[i]]["State"].item())
```
### **Chart Type:** Doughnut Plot
We have decided to further investigate the outlier states so as to better understand the factors that led to an increased number of incidents involving firearms.

The first type of analysis targets the age categories. For this purpose, the data was visualized in separate doughnut charts as seen below.

Calculating the percentage of Child, Teenager and Adult participants for each state.
```{python}
outlierList = np.array(outlierList)
totalsStates = np.zeros(shape=(len(outlierList),3), dtype = float)
categories = np.array(["CHILDREN", "TEENAGERS", "ADULTS"])

for i in range(0,len(outlierList)):
    state = outlierList[i]
    array = []

    dfHelper = fullsetDF[fullsetDF["state"]==state][categories[0]].copy(deep=True)
    totalsStates[i][0] = dfHelper.sum().item()

    dfHelper = fullsetDF[fullsetDF["state"]==state][categories[1]].copy(deep=True)
    totalsStates[i][1] = dfHelper.sum().item()

    dfHelper = fullsetDF[fullsetDF["state"]==state][categories[2]].copy(deep=True)
    totalsStates[i][2] = dfHelper.sum().item()

# Percentages per state for each group
for i in range(0, len(outlierList)):
    total = totalsStates[i][0] + totalsStates[i][1] + totalsStates[i][2]
    for j in range(0, 3):
        totalsStates[i][j] = float("{:.4f}".format(totalsStates[i][j] / total))*100
```

```{r}
donut_plot_labels <- function(all_labels, all_values, title) {
  
data = data.frame(name = all_labels, value = all_values)

data$ymax = cumsum(all_values)
data$ymin = c(0, head(data$ymax, n=-1))

data$labelPosition <- (data$ymax + data$ymin) / 2
data$label <- paste0(data$value, "%")

ggplot(data, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=name)) + 
  geom_rect() +
  geom_text(x=2, aes(y=labelPosition, label=label, color=name), size=3) +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_brewer(palette = "Dark2") +
  coord_polar(theta="y") +
  xlim(c(-1, 4)) +
  ggtitle(title) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank())
}
```
  
**Numeric Variables: Percentage of each age group involved in an incident in one state**
```{r}
r_categories <- py$categories
r_outlierList <- py$outlierList

matrix <- py$totalsStates
for(row in 1 : nrow(matrix)){
  r_totalsStates<- matrix[row,]
  print(donut_plot_labels(r_categories, r_totalsStates, r_outlierList[row]))
}
```

In all of the four graphs we can see that the majority of people involved in gun-violence are adults, followed by teenagers and the children. This might be an expected result, howver plotting this information made us discover that there are differences in the age group percentages across the states. 

For this reason, we will also design an overview of the age groups across the outlier states to gain a better understanding of the aspect we just noticed.

```{python}
# Percentages per group for each state
for j in range(0, 3):
    total = 0
    for i in range(0, len(outlierList)):
        total = total + totalsStates[i][j]

    for i in range(0, len(outlierList)):
        totalsStates[i][j] = float("{:.4f}".format(totalsStates[i][j] / total))*100
totalsStates = totalsStates.transpose()
```

**Numeric Variables: Percentage per state for one age group**
```{r}
matrix <- py$totalsStates
for(row in 1 : nrow(matrix)){
  r_totalsStates<- matrix[row,]
  print(donut_plot_labels(r_outlierList, r_totalsStates, r_categories[row]))
}
```

For the Adults category, the differences between the states are generally not that significant, the values for each state being somewhere around 25-40%.

The results for the other two categories have, however, glaring differences. The percentage of children involved is higher in the state of Texas and Florida than in the other two states, while the percentage of Teenagers is higher in Illinois and Florida.

### **Chart Type:** Circular BarPlot
Circular Barplots are a variation of the a barplot and it uses one numerical variable and one categorical.

The purpose of the following section is to identify the number of guns used in all the incidents per state. We have noticed that there are several incidents with at least 3 guns involved.

```{python}
gunsTotalPerState = []
for i in range (0, len(stateCodesDF)):
    state = stateCodesDF["State"][i]
    dfHelper = fullsetDF[fullsetDF["state"]==state]["n_guns_involved"].copy(deep=True)
    gunsTotalPerState.append(dfHelper.sum().item())
gunsTotalPerState = np.array(gunsTotalPerState)
```

```{r}
circular_barplot <- function(all_labels, all_values, x_name, y_name, plot_title, colour){
  
  data=data.frame(name = all_labels, value = all_values)

  totalIncidentsBarPlot <- ggplot(data, aes(x=name, y = value)) + geom_bar(stat = "identity", width=0.7, fill = colour) + 
    xlab(x_name) + 
    ylab(y_name) +
    ggtitle(plot_title)+
    theme(
      plot.title = element_text(hjust = 0.5),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white")
  ) +
  coord_polar(start = 0)
  
  options(repr.plot.width = 40, repr.plot.height = 40)
  totalIncidentsBarPlot
}
```

**Numeric Variable: Total number of guns**

**Categoric Variable: State codes**
```{r}
r_gunsTotalPerState <- py$gunsTotalPerState

circular_barplot(r_labels, r_gunsTotalPerState, "State Code", "Number of guns", "Distribution of no of guns involved per State", "#091CC1")
```

We can clearly see that there are several states where the number of guns is a lot higher, specifically California, Florida, Texas and Illinois. As we remember from the initial plots, these are the exact states that had the highest number of incidents as well.

## Further Analysis
### **Chart Type:** Heatmap
The variables used for a heatmap are two categoric ones.

We have previously split the incident type into 7 different categories. We would now like to make an analysis of the causes of gun-violence, i.e. how often each type occurs for the individual states.
```{python}
typeTotalPerState = np.empty(shape=(len(incidentType)*len(stateCodesDF)))
it = 0
for i in range(0, len(incidentType)):
    incident = incidentType[i]

    for j in range (0, len(stateCodesDF)):
        state = stateCodesDF["State"][j]
        dfHelper = fullsetDF[(fullsetDF["state"]==state) & (fullsetDF[incident] == "YES")][incident].copy(deep=True)

        typeTotalPerState[it] = dfHelper.count()
        it = it + 1

def dataCleaning(dataframe):
  allYears = [2013, 2014, 2015, 2016, 2017, 2018]
  for i in range(0, len(statesAll)):
      for j in range(i*6, i*6+6):
          year = allYears[j - i*6]
          if (dataframe.iloc[j]["YEAR"] != year):
              insertValue = [statesAll[i], year, 0]
              insertRow(j, dataframe, insertValue)
              dataframe = dataframe.sort_index(axis=0)
              j = j-1
```

**Categorical variables: Incident Type and the States Codes**
```{r}
r_typeTotalPerState <- py$typeTotalPerState
x <- py$stateCodes
y <- py$incidentType
data <- expand.grid(X=x, Y=y)

data$Z <- r_typeTotalPerState

ggplot(data, aes(X, Y, fill=Z)) + 
 geom_tile() + 
  scale_fill_distiller(palette = "Greens") + 
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
```

The most common type of incident is a mass shooting, followed by gang fights, while the other types (such as domestic violence, home invasion etc.) are less common.

### **Chart Type:** Trending Animated Bar Chart
This type of graph uses the same information as a standard Bar Chart (i.e. one numeric variable), but additionally uses a time component.

We first calculate the number of people injured for each state during each year available in the given dataset. We noticed that for certain years and states, there were no incidents reported and as such, those entries needed to be added to the dataframe with the value 0 in order to be able to plot the data.
```{python}
statesAll = stateCodesDF["State"]
def insertRow(row_number, df, row_value):
    start_upper = 0
    end_upper = row_number
    start_lower = row_number
    end_lower = df.shape[0]
    upper_half = [*range(start_upper, end_upper, 1)]
    lower_half = [*range(start_lower, end_lower, 1)]
    lower_half = [x.__add__(1) for x in lower_half]
    index_ = upper_half + lower_half
    df.index = index_
    df.loc[row_number] = row_value
```

```{python}
peopleInjuredByStateandDate = fullsetDF[["state", "MONTH", "YEAR", "n_injured"]]
peopleInjuredByStateandDate = peopleInjuredByStateandDate.groupby([peopleInjuredByStateandDate["state"], peopleInjuredByStateandDate["YEAR"]], as_index=False).agg({"n_injured" : "sum"})

peopleInjuredByStateandDate.rename(columns = {'n_injured':'var'}, inplace = True)

dataCleaning(peopleInjuredByStateandDate)
```

```{r}
myColors <- c("#cd0000", "#dc4c4c", "#f97300", "#00baba", "#e5dcd6", "#eff0ff", "#bccaff", "#87a0ff", "#577aff", "#2451ff", "#b3e1d9", "#18beaf", "#10736e", "#d4bf84", "#77320b", "#02b9c7", "#ccc8c3", "#56e8ea", "#b91b4b", "#8a3d01", "#fd69b3", "#550080", "#daf7a6", "#000084", "#ff6600", "#bc4b4b", "#140e00", "#0000ff", "#000000", "#eeeeee", "#e47cd2", "#bbedf9", "#fde6c8", "#fac813", "#009e7e", "#325da7", "#f68c06", "#f7f7f7", "#ffffff", "#181818", "#9aa7d0", "#b7b6f9", "#05014a", "#a03b3b", "#ffebcd", "#854442", "#0f403f", "#3b2f2f", "#0488c2", "#03a086")
rankingPlot <- function(data, plot_title){

  totalIncidentsRankingBarChart <- ggplot(data, aes(rank, group = state, fill = as.factor(state), color = as.factor(state))) + 
    geom_tile(aes(y = var/2, height = var, width = 0.9), alpha = 0.8, color = NA) +
    geom_text(aes(y = 0, label = paste(state, " ")), vjust = 0.2, hjust = 1, size = 6) +
    geom_text(aes(y = var, label = n_lbl, hjust = 0), size = 6) +
    coord_flip(clip = "off", expand = FALSE) +
    scale_y_continuous(labels = scales::comma) +
    scale_x_reverse() +
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white"),
      axis.text.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      plot.title = element_text(size = 25),
      legend.position = "none",
      plot.margin = margin(4, 4, 4, 4, "cm")
    ) + 
    scale_color_manual(values=myColors) + 
    scale_fill_manual(values=myColors)
  anim <- totalIncidentsRankingBarChart + 
    transition_states(YEAR, transition_length = 5, state_length = 5) +
    view_follow(fixed_x = TRUE) +
    labs(title = plot_title)
    
  
  animate(anim, 200, fps = 20,  width = 1200, height = 1000, 
        renderer = gifski_renderer("gganim.gif"))
}
```

```{r}
dataPrep <- function(dataframe){
  dataframe <- dataframe %>%
  group_by(YEAR) %>%
  mutate(rank = rank(-var),
         n_rel = var/var[rank==1],
         n_lbl = paste0(round(var, 2))) %>%
  group_by(state) %>%
  filter(rank <=10) %>%
  ungroup()
}
```

**Numeric Variable: Total number of injuries for each state for each year**
```{r}
r_totalPerState <- py$peopleInjuredByStateandDate

r_totalPerState <- dataPrep(r_totalPerState)

rankingPlot(r_totalPerState, 'Ranking of total number of injuries per year: {closest_state}')
```

Illinois has the highest level of injuries during the past couple of years, followed by California and Florida. A slight overall decrease can be noticed.

The same process described above was followed for the number of deaths
```{python}
peopleKilledByStateandDate = fullsetDF[["state", "YEAR", "n_killed"]]
peopleKilledByStateandDate = peopleKilledByStateandDate.groupby([peopleKilledByStateandDate["state"], peopleKilledByStateandDate["YEAR"]], as_index=False).agg({"n_killed" : "sum"})
peopleKilledByStateandDate.rename(columns = {'n_killed':'var'}, inplace = True)

dataCleaning(peopleKilledByStateandDate)
```

**Numeric Variable: Total number of deaths for each state for each year**
```{r}
r_totalPerState <- py$peopleKilledByStateandDate

r_totalPerState <- dataPrep(r_totalPerState)

rankingPlot(r_totalPerState, 'Ranking of total number of deaths per year: {closest_state}')
```

California and Texas have the highest number of incidents that resulted in deaths. There is no clear trend of either decrease or increase in the numbers.

### **Chart Type:** Scatter Plot
The next analysis targets the number of females and males involved in incidents for each state as we want to see if this might also be considered a factor. Statistics generally show that women commit less crimes than men. However, this is a very general statement and we want to see if it is also applicable for gun-involved incidents in our time frame.

A scatter plot uses two unordered numeric variables.
```{python}
malefemaleDistribution = fullsetDF[["state", "FEMALES", "MALES"]]
malefemaleDistribution = malefemaleDistribution.groupby([malefemaleDistribution["state"]], as_index=False).agg({"FEMALES" : "sum", "MALES" : "sum"})
malefemaleDistribution = malefemaleDistribution[["FEMALES", "MALES"]]

malefemaleDistribution.index = statesAll
```

```{r}
simpleScatter <- function(data){
  ggplot(data, aes(x=FEMALES, y=MALES)) + 
    geom_point() +
    geom_text(label=rownames(data), check_overlap = T)
}
```

**Numeric Variables: Total number of females involved, Total number of males involved**
```{r}
r_data <- py$malefemaleDistribution

simpleScatter(r_data)
```

The distribution between the two is fairly equal. We do see some states that have a higher level of males involved (Illinois or California, Arkansas), but we also see states with a higher number of females involved (Florida, Texas, Georgia).

### **Chart Type:** WordCloud
A wordcloud uses a numeric and a categoric variable. It uses a list of words, each of them having a frquency which is expressed in the graph through the size of the word shown.

Lastly, we want to see if there are locations where the level of crime is higher than in the others. We do have a lot of unknown locations in the dataset, however, just to give an idea of where most incidents occurred, we have plotted a Word Chart as seen below.

```{python}
column_names = ["word", "freq"]


locationTypeTotal = pd.DataFrame(columns = column_names)

for i in range (0, len(locationType)):
    array = []
    location = locationType[i]
    dfHelper = fullsetDF[fullsetDF["LocationType"]==location]["LocationType"].copy(deep=True)
    array.append(location)
    array.append(dfHelper.count().item())

    locationTypeTotal.loc[-1] = array
    locationTypeTotal.index = locationTypeTotal.index + 1
    locationTypeTotal = locationTypeTotal.sort_index()

for i in range(0, len(locationTypeTotal)):
    locationTypeTotal = locationTypeTotal.rename(index={i: locationTypeTotal["word"][i]})
    
words = np.array(locationTypeTotal["word"])
freq = np.array(locationTypeTotal["freq"], dtype=int)
```

```{r}
wordGraph <- function(dataFreq) {
  wordcloud2(data=dataFreq, size=1)
}
```

**Numeric Variable: The total number of incidents recorded at each known venue**

**Categoric Variable: The list of venues**
```{r}
r_words <- py$words
r_freq <- py$freq
r_location <- data.frame(word = r_words, freq = r_freq)

wordGraph(r_location)
```

As one would expect, the places with the highest rate of gun-violence are parks, apartments(i.e. at home), schools or bars.

### **Chart Type:** Doughnut Chart
We want

Variables: Total number of incidents, total number of incidents per state => procent

Calculating total number of incidents per state and adding them into a dictionary.
The states with incident percentages less than 1% will be categorized as others.
```{python}
totalPerState = []
incidentsStatesArray = np.array(fullsetDF['state'].to_numpy())
for i in range(0, len(stateCodesDF)):
    state = stateCodesDF["State"][i]
    totalPerState.append(incidentsStatesArray[incidentsStatesArray == state].shape[0])
        
DictStateIncident = {"Others": 0}
dfHelper = fullsetDF[fullsetDF["state"]==state]['state'].copy(deep=True)
totalIncidents = len(dfHelper)

incidentsPerStatePercentages = (np.array(totalPerState) / totalIncidents)
for i in range(0,len(stateCodes)):
    if incidentsPerStatePercentages[i] > 1:
        DictStateIncident[stateCodes[i]] = round(incidentsPerStatePercentages[i], 2)
    else:
        DictStateIncident["Others"] = DictStateIncident["Others"] + round(incidentsPerStatePercentages[i], 2)
        
statesForDonut = np.array(list(DictStateIncident.keys()))
valuesForDonut = np.array(list(DictStateIncident.values()))
```

```{r}
donut_plot <- function(all_labels, all_values) {
  
data = data.frame(name = all_labels, value = all_values)

data$ymax = cumsum(all_values)
data$ymin = c(0, head(data$ymax, n=-1))

ggplot(data, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=name)) + 
  geom_rect() +
  coord_polar(theta="y") +
  xlim(c(2, 4))
}
```

```{r}
r_labels <- py$statesForDonut
r_percentagesPerState <- py$valuesForDonut

donut_plot(r_labels, r_percentagesPerState)
```

Calculating the number of incidents per region: NE, NW, SW, SE.

We consider the center position the geographic center of the United States. This is a point approximately 32 km north of Belle Fourche, South Dakota at LAT. 39°50' LONG. −98°35'
```{python}
DictIncidentsPerRegion = {"NE": 0, "NW": 0, "SW": 0, "SE": 0}

incidentsCoordinates = fullsetDF[["latitude", "longitude"]]

for i in range(0, len(incidentsCoordinates)):
    if incidentsCoordinates["latitude"][i] > 39 and incidentsCoordinates["longitude"][i] > -98:
        DictIncidentsPerRegion["NE"] += 1
    if incidentsCoordinates["latitude"][i] > 39 and incidentsCoordinates["longitude"][i] < -98:
        DictIncidentsPerRegion["NW"] += 1
    if incidentsCoordinates["latitude"][i] < 39 and incidentsCoordinates["longitude"][i] < -98:
        DictIncidentsPerRegion["SW"] += 1
    if incidentsCoordinates["latitude"][i] < 39 and incidentsCoordinates["longitude"][i] > -98:
        DictIncidentsPerRegion["SE"] += 1

totalNoIncidents = sum(DictIncidentsPerRegion.values())
  
regions = np.array(list(DictIncidentsPerRegion.keys()))
incidentsPerRegions = np.round(np.array((np.array(list(DictIncidentsPerRegion.values())) / totalNoIncidents) * 100), 2)

```

```{r}
r_regions <- py$regions
r_incidentsPerRegion <- py$incidentsPerRegions

donut_plot_labels(r_regions, r_incidentsPerRegion, "Incidents per region")
```

### **Chart Type:** Lollipop chart with one numeric variable
In this section we want to highlight the top 25 and the bottom 25 news websites that reported crimes, which would help decide which online newspaper are the most and least trustworthy.
```{python}
sourcesPerIncident = fullsetDF[["date", "sources"]]

DictSourcesAndIncidents = {"pittsburgh.cbslocal.com" : 0}
for i in range (0, len(sourcesPerIncident["sources"])):
    try:
        sourcesArray = sourcesPerIncident["sources"][i].split("||")
    except:
        continue
    for source in sourcesArray:
        URI = source.strip().partition("//")[2]
        URL = URI.partition("/")[0]
        if URL in DictSourcesAndIncidents:
            DictSourcesAndIncidents[URL] += 1
        else:
            DictSourcesAndIncidents[URL] = 0

lessIncidentsPerSource = dict(filter(lambda elem: elem[1] != 0, DictSourcesAndIncidents.items()))

sort_by_value = lambda DictSourcesAndIncidents: DictSourcesAndIncidents[1]
sortedSourcesDict = sorted(DictSourcesAndIncidents.items(), key = sort_by_value, reverse=True)

sourcesName = []
sourceNews = []
for x in list(sortedSourcesDict)[0:25]:
    sourcesName.append(x[0])
    sourceNews.append(x[1])
    
sortedSourcesLeastTrustful = sorted(lessIncidentsPerSource.items(), key = sort_by_value)

sourcesLeastTrustful = []
appearancesLeastTrusful = []
for x in list(sortedSourcesLeastTrustful)[0:25]:
    sourcesLeastTrustful.append(x[0])
    appearancesLeastTrusful.append(x[1])
```


```{r}
library(plotly)

lollipop_function <- function(sources, appearances, title) {
    
    data <- data.frame(x = sources, y = appearances)
    
    p <- ggplot(data, aes(x=x, y=y)) +
      geom_segment( aes(x=reorder(x, y), xend=x, y=0, yend=y), color="grey") +
      geom_point( color="orange", size=4, fill=alpha("orange", 0.3), alpha=0.7, shape=21, stroke=2) +
      theme_light() +
      coord_flip() +
      ggtitle(title) +
      scale_size(range=c(2,12), guide="none") +
      theme(
        panel.grid.major.x = element_blank(),
        panel.border = element_blank(),
        axis.ticks.x = element_blank(),
        plot.title = element_text(size = 12)
      ) +
      xlab("") +
      ylab("Number of incidents reported for the whole period")
    
    ggplotly(p)
}
```

```{r}
r_source <- py$sourcesName
r_news <- py$sourceNews

lollipop_function(r_source, r_news, "The most trustworthy websites that reported gun-violence incidents")
```

```{r}
r_source <- py$sourcesLeastTrustful
r_news <- py$appearancesLeastTrusful

lollipop_function(r_source, r_news, "The least trustworthy websites that reported gun-violence incidents")
```

### **Chart Type:** Choropleth charts

```{python}
incidentsPerState = fullsetDF["state"].value_counts(ascending=False)

statesForMap = np.array(incidentsPerState.index)
incidentsForMap = np.array(incidentsPerState.values)

```

```{r}
file <- system.file("examples", "us_states.json", package = "geojsonio")
spdf <- geojson_read(file, what = "sp")

spdf_fortified <- tidy(spdf, region = "id")

r_states <- py$statesForMap
r_incidents <- py$incidentsForMap

numericData <- data.frame(id = r_states, incidents = r_incidents)

spdf_fortified <- merge(spdf_fortified, numericData, by="id")
```

```{r}

ggplot(data = spdf_fortified, aes( x = long, y = lat, group = group)) +
    geom_polygon(aes(fill = incidents), color = "black", size = 0.1) +
    coord_map() +
    labs(
      title = "US states map",
      subtitle = "Number of gun-violence incidents per state"
    ) +
    scale_fill_gradient(high = "#e34a33", low = "#fee8c8", guide = "colorbar") +
    theme(
      text = element_text(color = "#22211d"),
      plot.background = element_rect(fill = "#f5f5f2", color = NA),
      panel.background = element_rect(fill = "#f5f5f2", color = NA),
      legend.background = element_rect(fill = "#f5f5f2", color = NA),

      plot.title = element_text(size= 14, hjust=0.01, color = "#4e4d47", margin = margin(b = -0.1, t = 0.4, l = 2, unit = "cm")),
      plot.subtitle = element_text(size= 12, hjust=0.01, color = "#4e4d47", margin = margin(b = -0.1, t = 0.43, l = 2, unit = "cm")),
      plot.caption = element_text( size=12, color = "#4e4d47", margin = margin(b = 0.3, r=-99, unit = "cm") ),

      legend.position = c(0.9, 0.2)
    ) +
    xlim(c(-130, -65)) +
    ylim(c(20, 50))

```


INSERT DESCRIPTION HERE:

```{python}
peopleAggregatedByDate = fullsetDF[["date", "MONTH", "YEAR", "n_killed", "n_injured", "n_guns_involved"]]

peopleAggregatedByDate = peopleAggregatedByDate.groupby([peopleAggregatedByDate["YEAR"], peopleAggregatedByDate["MONTH"] ], as_index=False)\
    .agg({"n_killed" : "sum", "n_injured" : "sum", "n_guns_involved" : "sum", "date": np.max}).sort_values("date", ascending=True)

timeSeriesKilled = peopleAggregatedByDate[["date", "n_killed"]]
timeSeriesInjured = peopleAggregatedByDate[["date", "n_injured"]]
timeSeriesGuns = peopleAggregatedByDate[["date", "n_guns_involved"]]

n_killed = ["n_killed"] * len(timeSeriesKilled)
n_injured = ["n_injured"] * len(timeSeriesInjured)
n_guns = ["n_guns"] * len(timeSeriesGuns)

timeSeriesKilled = pd.DataFrame({
    "date": timeSeriesKilled["date"].to_numpy(),
    "variable": n_killed,
    "value": timeSeriesKilled["n_killed"].to_numpy()
})
timeSeriesKilled["index"] = timeSeriesKilled.index

timeSeriesInjured = pd.DataFrame({
    "date": timeSeriesInjured["date"].to_numpy(),
    "variable": n_injured,
    "value": timeSeriesInjured["n_injured"].to_numpy()
})
timeSeriesInjured["index"] = timeSeriesInjured.index

timeSeriesGuns = pd.DataFrame({
    "date": timeSeriesGuns["date"].to_numpy(),
    "variable": n_guns,
    "value": timeSeriesGuns["n_guns_involved"].to_numpy()
})
timeSeriesGuns["index"] = timeSeriesGuns.index

timeSeries = pd.concat([timeSeriesKilled, timeSeriesInjured, timeSeriesGuns])
timeSeriesDate = timeSeries["date"].to_numpy()
timeSeriesValue = timeSeries["value"].to_numpy()
timeSeriesIndex = timeSeries["index"].to_numpy()
timeSeriesVariable = timeSeries["variable"].to_numpy()

filteredDataAfterFirstYear = timeSeriesKilled[pd.to_datetime(timeSeriesKilled["date"]) >= pd.to_datetime('2014-01-01')]
filteredDataInjuredAfterFirstYear = timeSeriesInjured[pd.to_datetime(timeSeriesInjured["date"]) >= pd.to_datetime('2014-01-01')]
filteredDataGunsAfterFirstYear = timeSeriesGuns[pd.to_datetime(timeSeriesGuns["date"]) >= pd.to_datetime('2014-01-01')]

```

```{r}
r_date = py$filteredDataAfterFirstYear["date"]
r_value = py$filteredDataAfterFirstYear["value"]
data = data.frame(date = r_date, value = r_value)

data$date <- as.POSIXct(data$date, format = "%Y-%m-%d")

ggplot(data, aes(x=date, y=value)) +
  geom_point() +
  ggtitle("Evolution of number of murders in time after 2014") +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  theme(
    axis.text.x = element_text(angle = 90)
  )
```

```{r}
r_date = py$filteredDataInjuredAfterFirstYear["date"]
r_value = py$filteredDataInjuredAfterFirstYear["value"]
data = data.frame(date = r_date, value = r_value)

data$date <- as.POSIXct(data$date, format = "%Y-%m-%d")

ggplot(data, aes(x=date, y=value)) +
  geom_point() +
  ggtitle("Evolution of number of injured people in time after 2014") +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  theme(
    axis.text.x = element_text(angle = 90)
  )
```

```{r}
r_date = py$filteredDataGunsAfterFirstYear["date"]
r_value = py$filteredDataGunsAfterFirstYear["value"]
data = data.frame(date = r_date, value = r_value)

data$date <- as.POSIXct(data$date, format = "%Y-%m-%d")

ggplot(data, aes(x=date, y=value)) +
  geom_point() +
  ggtitle("Evolution of number of guns invloved in crimes over time after 2014") +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  theme(
    axis.text.x = element_text(angle = 90)
  )
```

```{r}
names = c("n_killed", "n_injured", "n_guns")
r_dates = py$timeSeriesDate
data = data.frame(x = py$timeSeriesDate, y = py$timeSeriesValue, variable=py$timeSeriesVariable, color=py$timeSeriesVariable)

data$x <- as.POSIXct(data$x, format = "%Y-%m-%d")

options(width = 800, height = 3)
ggplot(data, aes(x = x, y = y, group = variable, color = color)) +
    geom_line(linetype = 1, lwd = 0.5) +
    geom_point() +
    scale_color_viridis(discrete = TRUE) + theme_bw() +
    ggtitle("Evolution in time of number of murders, injured people and used guns") +
    theme(
      plot.title = element_text(hjust = 0.5),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "white"), 
      axis.text.x = element_text(angle = 90, size = 7),
      axis.line = element_line(colour = "darkblue", size = 0.7, linetype = "solid"),
      legend.position=c(0.1, 0.8)
    ) +
    transition_reveal(data$x)


```

```{python}
fullsetDF["people_involved"] = fullsetDF["MALES"] + fullsetDF["FEMALES"]
dataForNumberOfPeopleVsKilled = fullsetDF[["YEAR", "n_killed", "people_involved", "state", "city_or_county", "Mass Shooting"]]
print(dataForNumberOfPeopleVsKilled.head())

n_people = dataForNumberOfPeopleVsKilled["people_involved"]
n_killed = dataForNumberOfPeopleVsKilled["n_killed"]
state = dataForNumberOfPeopleVsKilled["state"]
city = dataForNumberOfPeopleVsKilled["city_or_county"]
years = dataForNumberOfPeopleVsKilled["YEAR"]
mass_shooting = dataForNumberOfPeopleVsKilled["Mass Shooting"]
```

```{r}
r_n_people <- py$n_people
r_n_killed <- py$n_killed
r_state <- py$state
r_city <- py$city
r_years <- as.numeric(py$years)
r_mass_shooting <- py$mass_shooting

data = data.frame(x = r_n_people, y = r_n_killed, color=r_mass_shooting, years=r_years)

ggplot(data, aes(x=r_n_people, y=r_n_killed, color=r_mass_shooting)) +
  geom_point(alpha = 0.7, stroke = 0) +
  theme_classic() +
  scale_size(range=c(2,12), guide="none") +
  labs(title = "Number of people involved VS number of people killed for the same incident",
       x = "People involved",
       y = "People killed",
       color = "Mass Shooting") +
  theme(axis.title = element_text(),
        legend.text = element_text(size = 6)) +
  scale_color_brewer(palette = "Set2") +
  transition_time(years) +
  labs(subtitle = "Year: {frame_time}") +
  shadow_wake(wake_length = 0.1) +
  ease_aes('linear')
```

# Overall Conclusions
A couple of conclusions can be drawn from the analysis undertaken, especially in relation to the impact several factor have on the level of gun-violence.

There are four states where the criminality rate is significant higher than in the others, some of them actually having a incredibly high number of children and teenagers involved. Most of the incidents were mass shooting.

More incidents were recorded in the Eastern part of the country than in the Western.
The gender of the participants is less relevant, 